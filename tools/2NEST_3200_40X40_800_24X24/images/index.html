<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firecast Visualization</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #sidebar {
      width: 300px;
      height: 100vh;
      float: left;
      overflow-y: auto;
      background: #f7f7f7;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
    }
    #map {
      margin-left: 300px;
      height: 100vh;
    }
    .param-button, .step-button {
      display: block;
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      text-align: left;
      box-sizing: border-box;
    }
    .active {
      background: #e0e0e0;
    }
    /* Next/Previous moved under the colorbar */
    #controls {
      margin-top: 10px;
      text-align: center;
    }
    #controls button {
      padding: 6px 12px;
      margin: 0 5px;
      cursor: pointer;
    }
    #colorbar-container {
      margin-top: 20px;
    }
  </style>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- JSZip for KMZ processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- toGeoJSON for converting KML to GeoJSON -->
  <script src="https://unpkg.com/@mapbox/togeojson@0.16.2/togeojson.js"></script>
  <!-- Leaflet-Velocity for wind overlay (assumed to be in the same directory) -->
  <script src="leaflet-velocity.js"></script>
</head>
<body>
  <div id="sidebar">
    <h3>Parameters</h3>
    <div id="parameterList"></div>
    <!-- Colorbar container (used when current parameter has a colorbar) -->
    <div id="colorbar-container"></div>
    <div id="controls">
      <button id="prevStep">Previous</button>
      <button id="nextStep">Next</button>
    </div>
    <h3>Steps</h3>
    <div id="stepList"></div>
  </div>
  <div id="map"></div>

  <script>
    /* Parameters object with updated colormap settings.
       Note: fronts now use geojson files.
    */
    const parameters = {
      "fronts": {
        ext: "geojson",
        steps: Array.from({length: 14}, (v, i) => i)  // 0 to 13
      },
      "plumeBottomHeight": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 5000,
        unit: "meters",
        steps: Array.from({length: 14}, (v, i) => i + 1)  // 1 to 14
      },
      "plumeTopHeight": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 5000,
        unit: "meters",
        steps: Array.from({length: 14}, (v, i) => i + 1)
      },
      "smokeAtGround": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 0.01,
        unit: "relative mass",
        steps: Array.from({length: 14}, (v, i) => i + 1)
      },
      "speed": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 1,
        unit: "m/s",
        steps: Array.from({length: 14}, (v, i) => i + 1)
      },
      "tke": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 3,
        unit: "m/s",
        steps: Array.from({length: 14}, (v, i) => i + 1)
      },
      "wind": {
        ext: "kmz",
        colorbar: "turbo.png",
        min: 0,
        max: 10,
        unit: "m/s",
        steps: Array.from({length: 14}, (v, i) => i + 1)
      }
    };

    let currentParameter = "fronts";
    let currentStepIndex = 0; // current step index (preserved across parameter changes)
    let currentLayer = null;
    let velocityLayer = null;

    // Initialize the map with a default view
    const map = L.map('map').setView([42.17, 9.17], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const parameterListDiv = document.getElementById("parameterList");
    const stepListDiv = document.getElementById("stepList");
    const colorbarContainer = document.getElementById("colorbar-container");
    const prevStepButton = document.getElementById("prevStep");
    const nextStepButton = document.getElementById("nextStep");

    // Update the colorbar display if the current parameter has one.
    function updateColorbarDisplay() {
      const paramConfig = parameters[currentParameter];
      if (paramConfig.colorbar) {
        colorbarContainer.innerHTML = `
          <div style="text-align: center; font-size: 12px;">${paramConfig.max}</div>
          <img src="${paramConfig.colorbar}" width="50" height="400" style="display: block; margin: auto;"/>
          <div style="text-align: center; font-size: 12px;">${paramConfig.min}</div>
          <div style="text-align: center; font-size: 12px;">${paramConfig.unit}</div>
        `;
      } else {
        colorbarContainer.innerHTML = "";
      }
    }

    // Build the parameter selection list.
    function buildParameterList() {
      parameterListDiv.innerHTML = "";
      Object.keys(parameters).forEach(param => {
        const btn = document.createElement("button");
        btn.textContent = param;
        btn.className = "param-button" + (param === currentParameter ? " active" : "");
        btn.onclick = () => {
          currentParameter = param;
          // Preserve the current step if possible
          currentStepIndex = Math.min(currentStepIndex, parameters[currentParameter].steps.length - 1);
          updateParameterSelection();
          updateColorbarDisplay();
          loadCurrentFile();
        };
        parameterListDiv.appendChild(btn);
      });
    }

    // Build the steps list with labels.
    function buildStepList() {
      stepListDiv.innerHTML = "";
      const steps = parameters[currentParameter].steps;
      steps.forEach((step, index) => {
        const btn = document.createElement("button");
        btn.className = "step-button" + (index === currentStepIndex ? " active" : "");
        // For "speed" and "wind" parameters, fetch timestamp from file.
        if (currentParameter === "speed" || currentParameter === "wind") {
          btn.textContent = "Loading...";
          const filename = currentParameter + "_" + step + "." + parameters[currentParameter].ext;
          const getTimestamp = (currentParameter === "wind") ? getTimestampFromWindCS : getTimestampFromKMZ;
          getTimestamp(filename).then(timestamp => {
            btn.textContent = timestamp;
          }).catch(err => {
            console.error("Error loading timestamp for", filename, err);
            btn.textContent = "Step " + step;
          });
        } else {
          btn.textContent = "Step " + step;
        }
        btn.onclick = () => {
          currentStepIndex = index;
          updateStepSelection();
          loadCurrentFile();
        };
        stepListDiv.appendChild(btn);
      });
    }

    function updateParameterSelection() {
      Array.from(parameterListDiv.children).forEach(btn => {
        btn.classList.toggle("active", btn.textContent === currentParameter);
      });
      buildStepList();
    }

    function updateStepSelection() {
      Array.from(stepListDiv.children).forEach((btn, index) => {
        btn.classList.toggle("active", index === currentStepIndex);
      });
    }

    prevStepButton.onclick = () => {
      if (currentStepIndex > 0) {
        currentStepIndex--;
        updateStepSelection();
        loadCurrentFile();
      }
    };

    nextStepButton.onclick = () => {
      if (currentStepIndex < parameters[currentParameter].steps.length - 1) {
        currentStepIndex++;
        updateStepSelection();
        loadCurrentFile();
      }
    };

    // Function to extract timestamp from a KMZ file (for "speed" parameter).
    function getTimestampFromKMZ(filename) {
      return fetch(filename)
        .then(response => response.arrayBuffer())
        .then(data => JSZip.loadAsync(data))
        .then(zip => {
          let kmlFileName = null;
          zip.forEach((relativePath, zipEntry) => {
            if (relativePath.endsWith(".kml") && !kmlFileName) {
              kmlFileName = relativePath;
            }
          });
          if (!kmlFileName) {
            throw new Error("No KML file found in KMZ.");
          }
          return zip.file(kmlFileName).async("text");
        })
        .then(kmlText => {
          const parser = new DOMParser();
          const kml = parser.parseFromString(kmlText, "application/xml");
          const timeStampElem = kml.getElementsByTagName("TimeStamp")[0];
          if (timeStampElem) {
            const whenElem = timeStampElem.getElementsByTagName("when")[0];
            if (whenElem) return whenElem.textContent;
          }
          throw new Error("No timestamp found.");
        });
    }

    // Function to extract timestamp from a windCS JSON file (for "wind" parameter).
    function getTimestampFromWindCS(filename) {
      return fetch(filename)
        .then(response => response.json())
        .then(data => {
          if (data.header && data.header.refTime) {
            return data.header.refTime;
          }
          throw new Error("No refTime in windCS JSON.");
        });
    }

    // Load the wind arrow overlay using leaflet-velocity.
    function loadWindLayer(step) {
      const windFilename = "windCS_" + step + ".json";
      fetch(windFilename)
        .then(resp => resp.json())
        .then(windData => {
          if (velocityLayer) {
            map.removeLayer(velocityLayer);
          }
          velocityLayer = L.velocityLayer({
            displayValues: true,
            displayOptions: {
              velocityType: "Wind",
              position: "bottomleft",
              emptyString: "No velocity data",
              angleConvention: "bearingCW",
              showCardinal: false,
              useVectors: true,
              speedUnit: "ms",
              directionString: "Direction",
              speedString: "Speed"
            },
            data: windData,
            lineWidth: 3,
            minVelocity: parameters.wind.min,
            maxVelocity: parameters.wind.max,
            velocityScale: 0.005,
            opacity: 1,
            paneName: "overlayPane"
          });
          velocityLayer.addTo(map);
        })
        .catch(e => console.error("Error fetching wind data:", e));
    }

    // Load the file corresponding to the current parameter and step.
    function loadCurrentFile() {
      if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
      }
      const paramInfo = parameters[currentParameter];
      const step = paramInfo.steps[currentStepIndex];
      let filename = "";
      if (currentParameter === "fronts") {
        filename = "fronts_" + step + ".geojson";
        fetch(filename)
          .then(response => response.json())
          .then(geojson => {
            currentLayer = L.geoJSON(geojson);
            currentLayer.addTo(map);
            if (currentLayer.getBounds && currentLayer.getBounds().isValid()) {
              map.fitBounds(currentLayer.getBounds());
            }
          })
          .catch(err => console.error("Error loading GeoJSON file:", err));
      } else {
        filename = currentParameter + "_" + step + "." + paramInfo.ext;
        fetch(filename)
          .then(response => response.arrayBuffer())
          .then(data => JSZip.loadAsync(data))
          .then(zip => {
            let kmlFileName = null;
            zip.forEach((relativePath, zipEntry) => {
              if (relativePath.endsWith(".kml") && !kmlFileName) {
                kmlFileName = relativePath;
              }
            });
            if (!kmlFileName) {
              throw new Error("No KML file found in KMZ.");
            }
            return Promise.all([
              zip.file(kmlFileName).async("text"),
              Promise.resolve(zip)
            ]);
          })
          .then(([kmlText, zip]) => {
            const parser = new DOMParser();
            const kml = parser.parseFromString(kmlText, "application/xml");
            const groundOverlay = kml.getElementsByTagName("GroundOverlay")[0];
            if (!groundOverlay) throw new Error("No GroundOverlay found.");
            const latLonBox = groundOverlay.getElementsByTagName("LatLonBox")[0];
            const north = parseFloat(latLonBox.getElementsByTagName("north")[0].textContent);
            const south = parseFloat(latLonBox.getElementsByTagName("south")[0].textContent);
            const east = parseFloat(latLonBox.getElementsByTagName("east")[0].textContent);
            const west = parseFloat(latLonBox.getElementsByTagName("west")[0].textContent);
            const bounds = [[south, west], [north, east]];
            const icon = groundOverlay.getElementsByTagName("Icon")[0];
            let href = icon.getElementsByTagName("href")[0].textContent;
            let fileEntry = zip.file(href);
            if (!fileEntry) {
              for (const fname in zip.files) {
                if (fname.toLowerCase() === href.toLowerCase()) {
                  fileEntry = zip.file(fname);
                  break;
                }
              }
            }
            if (fileEntry) {
              return fileEntry.async("blob").then(blob => {
                const imageURL = URL.createObjectURL(blob);
                return { imageURL, bounds };
              });
            } else {
              return { imageURL: href, bounds };
            }
          })
          .then(({ imageURL, bounds }) => {
            currentLayer = L.imageOverlay(imageURL, bounds);
            currentLayer.addTo(map);
            map.fitBounds(bounds);
          })
          .catch(err => console.error("Error processing KMZ file:", err));
      }
      // Always load the wind arrow overlay for the current step.
      loadWindLayer(step);
    }

    // Initialize the interface.
    buildParameterList();
    buildStepList();
    updateColorbarDisplay();
    loadCurrentFile();
  </script>
</body>
</html>